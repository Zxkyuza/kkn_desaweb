<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
        }
        .customer-info {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-responsive {
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Aplikasi Pendataan Meteran Air</h1>
        
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="meter-tab" data-bs-toggle="tab" data-bs-target="#meter" type="button" role="tab">Pencatatan Meteran</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="customer-tab" data-bs-toggle="tab" data-bs-target="#customer" type="button" role="tab">Manajemen Pelanggan</button>
            </li>
        </ul>
        
        <div class="tab-content mt-3" id="myTabContent">
            <!-- Meter Reading Tab -->
            <div class="tab-pane fade show active" id="meter" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="searchInput" class="form-label">Kode Pelanggan atau Nama:</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Masukkan kode atau nama">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary" onclick="searchCustomer()">Cari</button>
                            </div>
                        </div>
                        <div class="customer-info mb-3" id="customerInfo"></div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="currentMeter" class="form-label">Meter Bulan Ini:</label>
                                <input type="number" class="form-control" id="currentMeter" min="0">
                            </div>
                        </div>
                        <div class="mb-3">
                            <h5 id="billTotal">Total Biaya: Rp 0</h5>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="paymentInput" class="form-label">Jumlah Dibayar:</label>
                                <input type="number" class="form-control" id="paymentInput" min="0" value="0">
                            </div>
                        </div>
pip install streamlit                        <!-- Pisahkan tombol Hitung dan Simpan -->
                        <button class="btn btn-primary me-2" onclick="hitungTotalBiaya()">Hitung</button>
                        <button class="btn btn-success" id="saveBtn" onclick="saveMeterData()" disabled>Simpan</button>
                    </div>
                </div>
            </div>
            
            <!-- Customer Management Tab -->
            <div class="tab-pane fade" id="customer" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" id="formTitle">Tambah Pelanggan Baru</h5>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="codeInput" class="form-label">Kode Pelanggan:</label>
                                <input type="text" class="form-control" id="codeInput">
                            </div>
                            <div class="col-md-4">
                                <label for="nameInput" class="form-label">Nama:</label>
                                <input type="text" class="form-control" id="nameInput">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="kampungInput" class="form-label">Kampung:</label>
                                <input type="text" class="form-control" id="kampungInput">
                            </div>
                            <div class="col-md-2">
                                <label for="rtrwInput" class="form-label">RT/RW:</label>
                                <input type="text" class="form-control" id="rtrwInput">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="tabunganInput" class="form-label">Tabungan (opsional):</label>
                                <input type="number" class="form-control" id="tabunganInput" min="0" value="0">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="submitCustomer" onclick="addCustomer()">Tambah Pelanggan</button>
                        
                        <h5 class="mt-4">Daftar Pelanggan</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="customerTable">
                                <thead>
                                    <tr>
                                        <th>Kode Pelanggan</th>
                                        <th>Nama</th>
                                        <th>Kampung</th>
                                        <th>RT/RW</th>
                                        <th>Tabungan</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="customerTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const RATE_PER_M3 = 2200; // Tarif per mÂ³ (Rp)
        let customers = JSON.parse(localStorage.getItem('customers')) || [];
        let selectedCustomer = null;
        let editIndex = -1;
        let totalBillCache = null; // cache hasil hitung

        // Initialize customers if empty
        if (!customers.length) {
            localStorage.setItem('customers', JSON.stringify([]));
        }

        // Load customer list on page load
        window.onload = () => updateCustomerList();

        function calculateBill(meterLast, meterCurrent, previousDebt) {
            if (meterCurrent < meterLast) {
                return [0, previousDebt]; // Meteran mundur, anggap 0 penggunaan
            }
            const usage = meterCurrent - meterLast;
            const bill = usage * RATE_PER_M3;
            const totalDue = bill + previousDebt;
            return [bill, totalDue];
        }

        function hitungTotalBiaya() {
            if (!selectedCustomer) {
                alert('Pilih pelanggan terlebih dahulu!');
                return;
            }
            const meterCurrent = parseFloat(document.getElementById('currentMeter').value);
            const payment = parseFloat(document.getElementById('paymentInput').value || 0);
            const meterLast = parseFloat(selectedCustomer['Meter Bulan Lalu'] || 0);
            const previousDebt = parseFloat(selectedCustomer['Jumlah Belum Dibayar'] || 0);

            if (isNaN(meterCurrent)) {
                alert('Masukkan nilai meteran yang valid!');
                return;
            }

            const [bill, totalDue] = calculateBill(meterLast, meterCurrent, previousDebt);
            document.getElementById('billTotal').textContent = `Total Biaya: Rp ${totalDue.toLocaleString('id-ID')}`;
            totalBillCache = {
                meterCurrent,
                payment,
                meterLast,
                previousDebt,
                bill,
                totalDue
            };
            document.getElementById('saveBtn').disabled = false;
        }

        function searchCustomer() {
            const searchTerm = document.getElementById('searchInput').value.trim().toUpperCase();
            if (!searchTerm) {
                alert('Masukkan kode pelanggan atau nama!');
                return;
            }

            selectedCustomer = customers.find(c => 
                c['Kode Pelanggan'].toUpperCase().includes(searchTerm) || 
                c['Nama'].toUpperCase().includes(searchTerm)
            );

            const customerInfo = document.getElementById('customerInfo');
            if (selectedCustomer) {
                const previousDebt = parseFloat(selectedCustomer['Jumlah Belum Dibayar'] || 0);
                customerInfo.innerHTML = `
                    <p><strong>Nama:</strong> ${selectedCustomer['Nama']}</p>
                    <p><strong>Kode Pelanggan:</strong> ${selectedCustomer['Kode Pelanggan']}</p>
                    <p><strong>Alamat:</strong> ${selectedCustomer['Kampung']} ${selectedCustomer['RT/RW']}</p>
                    <p><strong>Meter Bulan Lalu:</strong> ${selectedCustomer['Meter Bulan Lalu'] || 0}</p>
                    <p><strong>Tunggakan:</strong> Rp ${previousDebt.toLocaleString('id-ID')}</p>
                `;
                document.getElementById('currentMeter').value = '';
                document.getElementById('paymentInput').value = '0';
                document.getElementById('billTotal').textContent = 'Total Biaya: Rp 0';
                totalBillCache = null;
                document.getElementById('saveBtn').disabled = true;
            } else {
                alert('Pelanggan tidak ditemukan!');
                customerInfo.innerHTML = '';
                document.getElementById('currentMeter').value = '';
                document.getElementById('paymentInput').value = '0';
                document.getElementById('billTotal').textContent = 'Total Biaya: Rp 0';
                totalBillCache = null;
                document.getElementById('saveBtn').disabled = true;
            }
        }

        function saveMeterData() {
            if (!selectedCustomer) {
                alert('Pilih pelanggan terlebih dahulu!');
                return;
            }
            if (!totalBillCache) {
                alert('Silakan hitung total biaya terlebih dahulu!');
                return;
            }
            const {meterCurrent, payment, meterLast, previousDebt, bill, totalDue} = totalBillCache;
            const remainingDue = totalDue - payment;

            customers = customers.map(c => {
                if (c['Kode Pelanggan'] === selectedCustomer['Kode Pelanggan']) {
                    return {
                        ...c,
                        'Meter Bulan Lalu': meterCurrent.toString(),
                        'Meter Bulan Ini': meterCurrent.toString(),
                        'Meter Digunakan': (meterCurrent - meterLast).toString(),
                        'Harus Dibayar': bill.toString(),
                        'Sudah Dibayar': payment.toString(),
                        'Sisa Bulan Lalu': previousDebt.toString(),
                        'Sisa Bulan Ini': remainingDue.toString(),
                        'Jumlah Belum Dibayar': remainingDue.toString()
                    };
                }
                return c;
            });

            localStorage.setItem('customers', JSON.stringify(customers));
            alert('Data meteran dan pembayaran berhasil disimpan!');
            updateCustomerList();
            document.getElementById('searchInput').value = '';
            document.getElementById('customerInfo').innerHTML = '';
            document.getElementById('currentMeter').value = '';
            document.getElementById('paymentInput').value = '0';
            document.getElementById('billTotal').textContent = 'Total Biaya: Rp 0';
            selectedCustomer = null;
            totalBillCache = null;
            document.getElementById('saveBtn').disabled = true;
        }

        function addCustomer() {
            const code = document.getElementById('codeInput').value.trim();
            const name = document.getElementById('nameInput').value.trim();
            const kampung = document.getElementById('kampungInput').value.trim();
            const rtrw = document.getElementById('rtrwInput').value.trim();
            const tabungan = document.getElementById('tabunganInput').value || '0';

            if (!code || !name || !kampung || !rtrw) {
                alert('Lengkapi semua kolom wajib!');
                return;
            }

            if (editIndex === -1 && customers.some(c => c['Kode Pelanggan'] === code)) {
                alert('Kode pelanggan sudah ada!');
                return;
            }

            if (editIndex !== -1) {
                // Update existing customer
                customers[editIndex] = {
                    ...customers[editIndex],
                    'Kode Pelanggan': code,
                    'Nama': name,
                    'Kampung': kampung,
                    'RT/RW': rtrw,
                    'Tabungan': tabungan
                };
                localStorage.setItem('customers', JSON.stringify(customers));
                alert('Data pelanggan berhasil diperbarui!');
                editIndex = -1;
                document.getElementById('submitCustomer').textContent = 'Tambah Pelanggan';
                document.getElementById('formTitle').textContent = 'Tambah Pelanggan Baru';
            } else {
                // Add new customer
                const newCustomer = {
                    'Kode Pelanggan': code,
                    'Nama': name,
                    'Kampung': kampung,
                    'RT/RW': rtrw,
                    'Meter Bulan Lalu': '0',
                    'Meter Bulan Ini': '0',
                    'Meter Digunakan': '0',
                    'Harus Dibayar': '0',
                    'Sudah Dibayar': '0',
                    'Sisa Bulan Lalu': '0',
                    'Sisa Bulan Ini': '0',
                    'Jumlah Belum Dibayar': '0',
                    'Tabungan': tabungan
                };
                customers.push(newCustomer);
                localStorage.setItem('customers', JSON.stringify(customers));
                alert('Pelanggan baru berhasil ditambahkan!');
            }

            // Clear form
            document.getElementById('codeInput').value = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('kampungInput').value = '';
            document.getElementById('rtrwInput').value = '';
            document.getElementById('tabunganInput').value = '0';
            updateCustomerList();
        }

        function editPelanggan(index) {
            const customer = customers[index];
            document.getElementById('codeInput').value = customer['Kode Pelanggan'];
            document.getElementById('nameInput').value = customer['Nama'];
            document.getElementById('kampungInput').value = customer['Kampung'];
            document.getElementById('rtrwInput').value = customer['RT/RW'];
            document.getElementById('tabunganInput').value = customer['Tabungan'] || '0';
            editIndex = index;
            document.getElementById('submitCustomer').textContent = 'Simpan Perubahan';
            document.getElementById('formTitle').textContent = 'Edit Pelanggan';
        }

        function hapusPelanggan(index) {
            if (confirm('Apakah Anda yakin ingin menghapus pelanggan ini?')) {
                customers.splice(index, 1);
                localStorage.setItem('customers', JSON.stringify(customers));
                updateCustomerList();
                alert('Pelanggan berhasil dihapus!');
            }
        }

        function updateCustomerList() {
            const tableBody = document.getElementById('customerTableBody');
            tableBody.innerHTML = '';
            customers.forEach((c, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${c['Kode Pelanggan']}</td>
                    <td>${c['Nama']}</td>
                    <td>${c['Kampung']}</td>
                    <td>${c['RT/RW']}</td>
                    <td>Rp ${parseFloat(c['Tabungan'] || 0).toLocaleString('id-ID')}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editPelanggan(${index})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="hapusPelanggan(${index})">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
    </script>
</body>
</html>